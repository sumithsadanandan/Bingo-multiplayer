
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sumith's Bingo</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f6f4ff; color:#222; transition:background 0.3s;}
body.pastel{background:#f6f4ff;}
body.neon{background:#1a1a2e; color:#eee;}
body.soft{background:#e8f4f8; color:#333;}
header{padding:16px;text-align:center;font-weight:700;font-size:24px;}
.wrap{max-width:480px;margin:20px auto;padding:12px;}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,0.1);}
body.neon .card{background:#16213e;color:#eee;}
body.soft .card{background:#fff;}
button,input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:15px;margin-top:10px;cursor:pointer;}
button{background:#6c5ce7;color:#fff;font-weight:600;border:none;}
button:hover{background:#5f4fd1;}
button:disabled{background:#ccc;cursor:not-allowed;}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:16px}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:12px;background:#eae9ff;font-weight:700;font-size:18px;cursor:pointer;user-select:none;transition:all 0.2s;}
body.neon .cell{background:#0f3460;}
body.soft .cell{background:#d4e9f2;}
.cell:hover{transform:scale(1.05);}
.cell.marked{background:#b8f2c2;color:#000;}
body.neon .cell.marked{background:#48c774;color:#000;}
body.soft .cell.marked{background:#a8dadc;color:#000;}
.cell.not-my-turn{cursor:not-allowed;opacity:0.6;}
.status{text-align:center;margin-top:12px;font-weight:600;font-size:16px;}
.hidden{display:none!important;}
#roomCodeDisplay{background:#e3f2fd;padding:12px;border-radius:8px;margin-bottom:12px;font-size:18px;font-weight:700;}
.info-box{background:#e8f5e9;padding:12px;border-radius:8px;margin-top:12px;font-size:14px;}
body.neon .info-box{background:#2d4a3e;}
#bingoLabel{font-size:28px;font-weight:800;color:#6c5ce7;margin-top:16px;}
body.neon #bingoLabel{color:#48c774;}
.winner-msg{color:#e74c3c;font-size:20px;font-weight:800;}
.loading{text-align:center;padding:20px;color:#999;}
canvas{position:fixed;inset:0;pointer-events:none;}
</style>
</head>
<body class="pastel">
<header>ðŸŽ‰ Sumith's Bingo</header>
<div class="wrap">
  <div id="loading" class="loading">Loading Firebase...</div>
  
  <div id="lobby" class="card hidden">
    <div id="roomCodeDisplay" class="status hidden"></div>
    <button id="createBtn">Create Room</button>
    <input id="roomInput" placeholder="Enter room code to join">
    <button id="joinBtn">Join Room</button>
    <select id="themeSelect">
      <option value="pastel">ðŸŒ¸ Pastel</option>
      <option value="neon">âš¡ Neon</option>
      <option value="soft">ðŸ§Š Soft</option>
    </select>
    <p id="lobbyStatus" class="status"></p>
    <button id="startBtn" class="hidden" disabled>Waiting for players...</button>
  </div>

  <div id="game" class="card hidden">
    <div id="roomLabel" class="status"></div>
    <div id="scoreBoard" class="status" style="background:#fff3cd;padding:10px;border-radius:8px;margin:10px 0;font-size:18px;">
      <strong>Score:</strong> P1: <span id="p1Score">0</span> | P2: <span id="p2Score">0</span>
    </div>
    <div id="turnLabel" class="status"></div>
    <div class="info-box" id="infoBox">Waiting for game to start...</div>
    <div id="board" class="grid"></div>
    <div id="bingoLabel" class="status"></div>
    <button id="newGameBtn" class="hidden">New Game</button>
  </div>
</div>

<!-- Bingo Sound -->
<audio id="bingoSound" src="sound-effect-bingo-122339.mp3"></audio>
<!-- Confetti -->
<canvas id="confetti"></canvas>

<!-- Firebase v9 Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== CONFETTI SETUP =====
let confettiFrameId = null;
function confetti(){
  const c=document.getElementById('confetti');
  const ctx=c.getContext('2d');
  c.width=innerWidth;
  c.height=innerHeight;
  const pieces=[...Array(120)].map(()=>({
    x:Math.random()*c.width,
    y:-20,
    r:Math.random()*6+4,
    v:Math.random()*3+2,
    col:['#f48fb1','#ce93d8','#b39ddb','#80cbc4','#a5d6a7'][Math.floor(Math.random()*5)]
  }));
  let frame=0;
  function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    pieces.forEach(p=>{
      p.y+=p.v;
      ctx.fillStyle=p.col;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    });
    if(frame++<180){
      confettiFrameId=requestAnimationFrame(draw);
    } else stopConfetti();
  }
  draw();
}
function stopConfetti(){
  const c=document.getElementById('confetti');
  const ctx=c.getContext('2d');
  if(confettiFrameId){ cancelAnimationFrame(confettiFrameId); confettiFrameId=null; }
  ctx.clearRect(0,0,c.width,c.height);
}

// ===== INIT APP =====
window.addEventListener('load', function() {
  if (typeof firebase === 'undefined') {
    document.getElementById('loading').innerHTML = 'âŒ Firebase failed to load.';
    return;
  }
  initApp();
});

function initApp() {
  firebase.initializeApp({
    apiKey: "AIzaSyCKZ-ktAV8MPyZbjwkuzszTUEzHXvoKOGA",
    authDomain: "bingo-multiplayer-315fb.firebaseapp.com",
    databaseURL: "https://bingo-multiplayer-315fb-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bingo-multiplayer-315fb",
    storageBucket: "bingo-multiplayer-315fb.appspot.com",
    messagingSenderId: "157740745674",
    appId: "1:157740745674:web:a4bdabb3bc8a05d024c533"
  });
  
  const db = firebase.database();
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('lobby').classList.remove('hidden');

  // ===== VARIABLES =====
  let roomId = null, playerId = null, isOwner = false;
  let myBoard = [], myMarked = [], completedLines = new Set(), gameStarted=false, currentTurn=null;
  let listenersAttached=false, isCheckingWinner=false;

  const createBtn=document.getElementById('createBtn');
  const joinBtn=document.getElementById('joinBtn');
  const startBtn=document.getElementById('startBtn');
  const newGameBtn=document.getElementById('newGameBtn');
  const roomInput=document.getElementById('roomInput');
  const lobbyStatus=document.getElementById('lobbyStatus');
  const lobbyCard=document.getElementById('lobby');
  const gameCard=document.getElementById('game');
  const roomLabel=document.getElementById('roomLabel');
  const roomCodeDisplay=document.getElementById('roomCodeDisplay');
  const turnLabel=document.getElementById('turnLabel');
  const boardEl=document.getElementById('board');
  const bingoLabel=document.getElementById('bingoLabel');
  const themeSelect=document.getElementById('themeSelect');
  const infoBox=document.getElementById('infoBox');
  const p1Score=document.getElementById('p1Score');
  const p2Score=document.getElementById('p2Score');
  const bingoSound = document.getElementById('bingoSound');

  themeSelect.onchange=e=>document.body.className=e.target.value;

  function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}

  // ===== ROOM CREATION =====
  createBtn.onclick=async()=>{
    roomId=Math.random().toString(36).substring(2,7).toUpperCase();
    playerId="P1"; isOwner=true;
    await db.ref(`rooms/${roomId}`).set({players:{P1:true},started:false,turn:"P1",boards:{},marks:{},scores:{P1:0,P2:0},winner:null,lastMove:null});
    enterRoomUI();
  };
  joinBtn.onclick=async()=>{
    const val=(roomInput.value||"").trim().toUpperCase();
    if(!val){alert("Enter room code"); return;}
    const roomSnap=await db.ref(`rooms/${val}`).once('value');
    if(!roomSnap.exists()){alert("Room not found!"); return;}
    const players=Object.keys(roomSnap.val().players||{});
    if(players.length>=2){alert("Room is full!"); return;}
    roomId=val; playerId="P2"; isOwner=false;
    await db.ref(`rooms/${roomId}/players/P2`).set(true);
    enterRoomUI();
  };

  function enterRoomUI(){
    createBtn.style.display='none'; joinBtn.style.display='none'; roomInput.style.display='none'; themeSelect.style.display='none';
    roomCodeDisplay.classList.remove('hidden');
    roomCodeDisplay.innerHTML=`<strong>ðŸŽ® Room Code: ${roomId}</strong><br><small>Share with Player 2</small>`;
    roomLabel.innerText=`Room: ${roomId} | You are Player ${playerId.substring(1)}`;
    if(isOwner) startBtn.classList.remove('hidden');
    if(!listenersAttached){ attachRoomListener(); listenersAttached=true; }
  }

  startBtn.onclick=async()=>{
    const snap=await db.ref(`rooms/${roomId}/players`).once('value');
    const playersObj = snap.val()||{};
    if(Object.keys(playersObj).length<2){alert("Need 2 players!"); return;}
    const p1Board=shuffle([...Array(25).keys()].map(n=>n+1));
    const p2Board=shuffle([...Array(25).keys()].map(n=>n+1));
    await db.ref(`rooms/${roomId}`).update({boards:{P1:p1Board,P2:p2Board},marks:{P1:{},P2:{}},started:true,turn:"P1",winner:null,lastMove:null});
  };

  newGameBtn.onclick=async()=>{
    const p1Board=shuffle([...Array(25).keys()].map(n=>n+1));
    const p2Board=shuffle([...Array(25).keys()].map(n=>n+1));
    myBoard=[]; myMarked=[]; completedLines.clear(); gameStarted=false; bingoLabel.innerText=''; isCheckingWinner=false;
    await db.ref(`rooms/${roomId}`).update({boards:{P1:p1Board,P2:p2Board},marks:{P1:{},P2:{}},turn:"P1",winner:null,started:true,lastMove:null});
    newGameBtn.classList.add('hidden');
  };

  function attachRoomListener(){
    const roomRef=db.ref(`rooms/${roomId}`);
    roomRef.on('value',snap=>{
      const data=snap.val(); if(!data) return;
      const players=Object.keys(data.players||{});
      lobbyStatus.innerText=`Players: ${players.length}/2`;
      if(data.scores){ p1Score.innerText=data.scores.P1||0; p2Score.innerText=data.scores.P2||0; }
      if(isOwner){ startBtn.classList.remove('hidden'); 
        if(players.length===2 && !data.started){ startBtn.disabled=false; startBtn.innerText="Start Game"; }
        else if(data.started){ startBtn.disabled=true; startBtn.innerText="Game Started"; }
        else{ startBtn.disabled=true; startBtn.innerText="Waiting for Player 2..."; }
      } else { if(!data.started) lobbyStatus.innerText=`Players: ${players.length}/2 - Waiting for owner...`; }
      currentTurn=data.turn;
      const isMyTurn = currentTurn===playerId;
      if(data.winner){
        const winnerText = data.winner===playerId?"ðŸŽ‰ YOU WIN! ðŸŽ‰":`${data.winner} Won!`;
        bingoLabel.innerHTML=`<div class="winner-msg">${winnerText}</div>`;
        infoBox.innerText = "Game Over!";
        gameStarted=false;
        newGameBtn.classList.remove('hidden'); newGameBtn.innerText="ðŸ”„ Play Again";
        return;
      } else newGameBtn.classList.add('hidden');
      if(data.started && data.boards && data.boards[playerId]){
        lobbyCard.classList.add('hidden'); gameCard.classList.remove('hidden');
        if(!data.winner) gameStarted=true;
        turnLabel.innerText = isMyTurn?"ðŸŸ¢ Your Turn!":`â³ Waiting for ${currentTurn}`;
        turnLabel.style.color = isMyTurn?"#27ae60":"#e67e22";
        myBoard=[...data.boards[playerId]];
        myMarked=Array(25).fill(false);
        completedLines.clear();
        const marksObj = data.marks?.[playerId]||{};
        Object.keys(marksObj).forEach(idx=>myMarked[Number(idx)]=true);
        infoBox.innerText = isMyTurn?"Click a number to mark it":"Wait for your turn";
        renderBoard();
        updateBingoLabel();
      }
    });
  }

  function renderBoard(){
    if(myBoard.length===0) return;
    boardEl.innerHTML='';
    const isMyTurn = currentTurn===playerId;
    for(let i=0;i<25;i++){
      const n=myBoard[i];
      const cell=document.createElement('div'); cell.className='cell';
      if(myMarked[i]) cell.classList.add('marked');
      if(!isMyTurn) cell.classList.add('not-my-turn');
      cell.innerText=n;
      cell.onclick=()=>onCellClick(i,n);
      boardEl.appendChild(cell);
    }
  }

  async function onCellClick(idx,number){
    if(!gameStarted) return;
    if(currentTurn!==playerId){ infoBox.innerText="âš ï¸ Not your turn!"; return; }
    if(myMarked[idx]) return;
    // mark number on all boards
    const boardsSnap = await db.ref(`rooms/${roomId}/boards`).once('value');
    const boardsObj = boardsSnap.val()||{};
    const updates={};
    Object.keys(boardsObj).forEach(pid=>{
      const board=boardsObj[pid];
      const index=board.indexOf(number);
      if(index>=0) updates[`rooms/${roomId}/marks/${pid}/${index}`]=true;
    });
    updates[`rooms/${roomId}/turn`]=playerId==="P1"?"P2":"P1";
    updates[`rooms/${roomId}/lastMove`]=playerId;
    await db.ref().update(updates);
    if(!isCheckingWinner){
      isCheckingWinner=true;
      setTimeout(async()=>{
        await checkForWinAfterMove();
        isCheckingWinner=false;
      },200);
    }
  }

  function updateBingoLabel(){
    const letters="BINGO"; completedLines.clear();
    for(let r=0;r<5;r++){ const idxs=[0,1,2,3,4].map(c=>r*5+c); if(idxs.every(i=>myMarked[i])) completedLines.add('R'+r); }
    for(let c=0;c<5;c++){ const idxs=[0,1,2,3,4].map(r=>r*5+c); if(idxs.every(i=>myMarked[i])) completedLines.add('C'+c); }
    const count=completedLines.size;
    if(count>=5){
      bingoLabel.innerText="ðŸŽ‰ BINGO! ðŸŽ‰";
      // Play sound & confetti
      try{ bingoSound.currentTime=0; bingoSound.play().catch(()=>{}); }catch{}
      confetti();
    } else bingoLabel.innerText=letters.slice(0,count);
    return count>=5;
  }

  function checkBingoForPlayer(marked){
    let completedCount=0;
    for(let r=0;r<5;r++){ const idxs=[0,1,2,3,4].map(c=>r*5+c); if(idxs.every(i=>marked[i])) completedCount++; }
    for(let c=0;c<5;c++){ const idxs=[0,1,2,3,4].map(r=>r*5+c); if(idxs.every(i=>marked[i])) completedCount++; }
    return completedCount>=5;
  }

  async function checkForWinAfterMove(){
    try{
      const roomSnap = await db.ref(`rooms/${roomId}`).once('value');
      const data = roomSnap.val(); if(!data) return;
      if(data.winner) return;
      const lastMovePlayer=data.lastMove; if(!lastMovePlayer) return;
      const boards=data.boards||{}

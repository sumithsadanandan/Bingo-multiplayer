<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sumithâ€™s Bingo</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f6f4ff; color:#222;}
header{padding:12px;text-align:center;font-weight:700;font-size:20px;}
.wrap{max-width:420px;margin:16px auto;padding:10px;}
.card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 22px rgba(0,0,0,0.08);}
button,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:15px;margin-top:8px}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:12px}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#eae9ff;font-weight:700;cursor:pointer;user-select:none}
.cell.marked{background:#b8f2c2}
.cell.completed{background:#ffd8a8}
.status{text-align:center;margin-top:8px;font-weight:600}
.hidden{display:none}
</style>
</head>
<body class="pastel">
<header>ðŸŽ‰ Sumithâ€™s Bingo</header>
<div class="wrap">
  <div id="lobby" class="card">
    <button id="createBtn">Create Room</button>
    <input id="roomInput" placeholder="Enter room code to join">
    <button id="joinBtn">Join Room</button>
    <select id="themeSelect">
      <option value="pastel">ðŸŒ¸ Pastel</option>
      <option value="neon">âš¡ Neon</option>
      <option value="soft">ðŸ§Š Soft</option>
    </select>
    <p id="lobbyStatus" class="status"></p>
    <button id="startBtn" class="hidden">Start Game (owner only)</button>
  </div>

  <div id="game" class="card hidden">
    <div id="roomLabel" class="status"></div>
    <div id="turnLabel" class="status"></div>
    <div id="board" class="grid"></div>
    <div id="bingoLabel" class="status"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ====== CONFIG: Replace with your Firebase project settings ====== */
firebase.initializeApp({
  apiKey: "AIzaSyCKZ-ktAV8MPyZbjwkuzszTUEzHXvoKOGA",
  authDomain: "bingo-multiplayer-315fb.firebaseapp.com",
  databaseURL: "https://bingo-multiplayer-315fb-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bingo-multiplayer-315fb",
  storageBucket: "bingo-multiplayer-315fb.firebasestorage.app",
  messagingSenderId: "157740745674",
  appId: "1:157740745674:web:a4bdabb3bc8a05d024c533",
  measurementId: "G-88SZ629W0B"
});
const db = firebase.database();

/* ===== Variables ===== */
let roomId = null;
let playerId = null; // "P1" or "P2"
let isOwner = false;
let board = [], boardMap = {}, marked = [], completedLines = new Set();

/* UI refs */
const createBtn=document.getElementById('createBtn');
const joinBtn=document.getElementById('joinBtn');
const startBtn=document.getElementById('startBtn');
const roomInput=document.getElementById('roomInput');
const lobbyStatus=document.getElementById('lobbyStatus');
const lobbyCard=document.getElementById('lobby');
const gameCard=document.getElementById('game');
const roomLabel=document.getElementById('roomLabel');
const turnLabel=document.getElementById('turnLabel');
const boardEl=document.getElementById('board');
const bingoLabel=document.getElementById('bingoLabel');
const themeSelect=document.getElementById('themeSelect');

/* ===== Theme change ===== */
themeSelect.onchange=e=>document.body.className=e.target.value;

/* ===== Helper ===== */
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}

/* ===== Lobby actions ===== */
createBtn.onclick=async()=>{
  roomId=Math.random().toString(36).substring(2,7).toUpperCase();
  playerId="P1"; isOwner=true;
  await db.ref(`rooms/${roomId}`).set({players:{P1:true},started:false,turn:"P1"});
  enterRoomUI();
};

joinBtn.onclick=async()=>{
  const val=(roomInput.value||"").trim().toUpperCase();
  if(!val){alert("Enter room code"); return;}
  roomId=val; playerId="P2"; isOwner=false;
  await db.ref(`rooms/${roomId}/players/P2`).set(true);
  enterRoomUI();
};

/* Enter game UI */
function enterRoomUI(){
  lobbyCard.classList.add('hidden'); gameCard.classList.remove('hidden');
  roomLabel.innerText=`Room: ${roomId}`;
  lobbyStatus.innerText="Connected. Waiting for players...";
  attachRoomListener();
}

/* Start game (owner only) */
startBtn.onclick=async()=>{
  const snap=await db.ref(`rooms/${roomId}/players`).once('value');
  const playersObj=snap.val()||{};
  if(Object.keys(playersObj).length<2){alert("Need 2 players"); return;}
  const boardsSnap=await db.ref(`rooms/${roomId}/boards`).once('value');
  if(!boardsSnap.exists()){
    const p1=shuffle([...Array(25).keys()].map(n=>n+1));
    const p2=shuffle([...Array(25).keys()].map(n=>n+1));
    const updates={};
    updates[`rooms/${roomId}/boards/P1`]=p1;
    updates[`rooms/${roomId}/boards/P2`]=p2;
    updates[`rooms/${roomId}/marks`]={};
    updates[`rooms/${roomId}/started`]=true;
    updates[`rooms/${roomId}/turn`]="P1";
    await db.ref().update(updates);
  } else {
    await db.ref(`rooms/${roomId}/started`).set(true);
  }
};

/* ===== Room listener ===== */
function attachRoomListener(){
  const roomRef=db.ref(`rooms/${roomId}`);
  roomRef.on('value',snap=>{
    const data=snap.val();
    if(!data) return;
    const players=Object.keys(data.players||{});
    lobbyStatus.innerText=`Players: ${players.length}/2`;
    if(isOwner && players.length===2 && !data.started) startBtn.classList.remove('hidden'); 
    else startBtn.classList.add('hidden');
    turnLabel.innerText=`Turn: ${data.turn||''}`;
    if(data.boards && data.started){
      boardMap=data.boards;
      if(boardMap[playerId]){
        board=boardMap[playerId];
        marked=Array(25).fill(false);
        completedLines.clear();
        attachMarksListener();
      }
    }
  });
}

/* ===== Marks listener ===== */
function attachMarksListener(){
  const marksRef=db.ref(`rooms/${roomId}/marks/${playerId}`);
  marksRef.on('value',snap=>{
    const marksObj=snap.val()||{};
    marked=Array(25).fill(false);
    Object.keys(marksObj).forEach(k=>marked[Number(k)]=true);
    renderBoard();
  });
}

/* ===== Render board ===== */
function renderBoard(){
  boardEl.innerHTML='';
  for(let i=0;i<25;i++){
    const n=board[i];
    const cell=document.createElement('div');
    cell.className='cell'+(marked[i]?' marked':'');
    cell.innerText=n;
    cell.onclick=()=>onCellClick(i);
    boardEl.appendChild(cell);
  }
  updateBingoLabel();
}

/* ===== Cell click ===== */
async function onCellClick(idx){
  const turnSnap=await db.ref(`rooms/${roomId}/turn`).once('value');
  if(turnSnap.val()!==playerId) return; // not your turn
  if(marked[idx]) return;

  const numberClicked=board[idx];
  const updates={};
  const boardsSnap=await db.ref(`rooms/${roomId}/boards`).once('value');
  const boardsObj=boardsSnap.val()||{};
  Object.keys(boardsObj).forEach(pid=>{
    const index=boardsObj[pid].indexOf(numberClicked);
    if(index>=0) updates[`rooms/${roomId}/marks/${pid}/${index}`]=true;
  });
  updates[`rooms/${roomId}/turn`]=playerId==="P1"?"P2":"P1";
  await db.ref().update(updates);
}

/* ===== Bingo logic ===== */
function updateBingoLabel(){
  const letters="BINGO";
  let currentCompleted=new Set();
  // rows
  for(let r=0;r<5;r++){const idxs=[0,1,2,3,4].map(c=>r*5+c); if(idxs.every(i=>marked[i])) currentCompleted.add('R'+r);}
  // columns
  for(let c=0;c<5;c++){const idxs=[0,1,2,3,4].map(r=>r*5+c); if(idxs.every(i=>marked[i])) currentCompleted.add('C'+c);}
  currentCompleted.forEach(x=>completedLines.add(x));
  const count=completedLines.size;
  bingoLabel.innerText=count>=5?"ðŸŽ‰ BINGO! ðŸŽ‰":letters.slice(0,count);
}
</script>
</body>
</html>

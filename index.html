<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sumithâ€™s Bingo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#fde2e4;
  --card:#fff;
  --marked:#e6dbff;
  --complete:#c8f7dc;
  --accent:#ec407a;
  --text:#444;
}
body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
}
body.neon{
  --bg:#0f2027;
  --card:#111;
  --marked:#7c4dff;
  --complete:#00e676;
  --accent:#00e5ff;
  --text:#e0f7fa;
}
body.soft{
  --bg:#e0e0e0;
  --card:#e0e0e0;
  --marked:#d1c4e9;
  --complete:#b2dfdb;
  --accent:#757575;
  --text:#333;
}
.app{width:100%;max-width:420px;padding:16px;}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
h1{margin:0;color:var(--text);}
select{border-radius:10px;padding:6px;}

.card{
  background:var(--card);
  border-radius:20px;
  padding:16px;
  margin-top:12px;
}
button{
  padding:10px 20px;
  border-radius:20px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  width:100%;
  margin-bottom:10px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
}
.cell{
  aspect-ratio:1;
  border-radius:14px;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  cursor:pointer;
}
.cell.marked{background:var(--marked);}
.cell.completed{background:var(--complete);}
.bingo{
  display:flex;
  justify-content:center;
  gap:10px;
  margin:10px 0;
}
.letter{
  width:36px;height:36px;
  border-radius:50%;
  border:2px solid var(--accent);
  display:flex;
  align-items:center;
  justify-content:center;
}
.letter.active{
  background:var(--accent);
  color:#fff;
}
#bingoMessage{
  text-align:center;
  font-size:24px;
  display:none;
}
.hidden{display:none;}
</style>
</head>

<body class="pastel">
<div class="app">

<header>
  <h1>Sumithâ€™s Bingo</h1>
  <select id="theme">
    <option value="pastel">ðŸŒ¸ Pastel</option>
    <option value="neon">âš¡ Neon</option>
    <option value="soft">ðŸ§Š Soft</option>
  </select>
</header>

<!-- LOBBY -->
<div class="card" id="lobby">
  <button onclick="createRoom()">Create Room</button>
  <hr/>
  <input id="roomInput" placeholder="Enter room code"/>
  <button onclick="joinRoom()">Join Room</button>
  <p id="lobbyStatus"></p>
  <button id="startBtn" class="hidden" onclick="startGame()">Start Game</button>
</div>

<!-- GAME -->
<div id="game" class="hidden">
  <div class="bingo">
    <div class="letter" id="b">B</div>
    <div class="letter" id="i">I</div>
    <div class="letter" id="n">N</div>
    <div class="letter" id="g">G</div>
    <div class="letter" id="o">O</div>
  </div>

  <div class="card">
    <div class="grid" id="grid"></div>
  </div>

  <div id="bingoMessage">ðŸŽ‰ BINGO ðŸŽ‰</div>
</div>

</div>

<script>
/* ðŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCKZ-ktAV8MPyZbjwkuzszTUEzHXvoKOGA",
  authDomain: "bingo-multiplayer-315fb.firebaseapp.com",
  databaseURL: "https://bingo-multiplayer-315fb-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bingo-multiplayer-315fb",
  storageBucket: "bingo-multiplayer-315fb.firebasestorage.app",
  messagingSenderId: "157740745674",
  appId: "1:157740745674:web:a4bdabb3bc8a05d024c533",
  measurementId: "G-88SZ629W0B"
});

const db = firebase.database();

/********************
 ðŸŽ® GAME STATE
********************/
const SIZE = 5;
let roomCode = null;
let playerNum = null; // 1 or 2
let roomRef = null;
let roomListener = null;

let cells = [];
let completed = new Set();
let bingo = false;

/********************
 ðŸŽ¨ THEME SWITCH
********************/
document.getElementById("theme").onchange = e => {
  document.body.className = e.target.value;
};

/********************
 ðŸ  CREATE ROOM
********************/
function createRoom(){
  roomCode = Math.random().toString(36).substring(2,7).toUpperCase();
  playerNum = 1;

  roomRef = db.ref("rooms/" + roomCode);
  roomRef.set({
    players: 1,
    started: false,
    currentPlayer: 1,
    calledNumbers: [],
    boards: {
      p1: generateBoard()
    }
  });

  listenLobby();
}

/********************
 ðŸšª JOIN ROOM
********************/
function joinRoom(){
  roomCode = document.getElementById("roomInput").value.trim().toUpperCase();
  if(!roomCode) return alert("Enter room code");

  roomRef = db.ref("rooms/" + roomCode);
  roomRef.once("value", snap => {
    if(!snap.exists()) return alert("Room not found");

    const data = snap.val();
    if(data.players >= 2) return alert("Room full");

    playerNum = 2;
    roomRef.update({
      players: 2,
      boards: {
        ...data.boards,
        p2: generateBoard()
      }
    });

    listenLobby();
  });
}

/********************
 ðŸ‘‚ LOBBY LISTENER
********************/
function listenLobby(){
  if(roomListener) roomRef.off("value", roomListener);

  roomListener = roomRef.on("value", snap => {
    const data = snap.val();
    if(!data) return;

    const status = document.getElementById("lobbyStatus");
    const startBtn = document.getElementById("startBtn");

    status.innerText = `Room: ${roomCode} | Players: ${data.players}/2`;

    // Start button ONLY for owner
    if(data.players === 2 && playerNum === 1 && !data.started){
      startBtn.classList.remove("hidden");
    } else {
      startBtn.classList.add("hidden");
    }

    if(data.players === 2 && playerNum === 2 && !data.started){
      status.innerText = "Waiting for host to start the gameâ€¦";
    }

    if(data.started){
      enterGame(data);
    }
  });
}

/********************
 â–¶ï¸ START GAME (OWNER ONLY)
********************/
function startGame(){
  if(playerNum !== 1) return;
  roomRef.update({ started: true });
}

/********************
 ðŸŽ¯ ENTER GAME
********************/
function enterGame(data){
  document.getElementById("lobby").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");

  const boardKey = playerNum === 1 ? "p1" : "p2";
  renderBoard(data.boards[boardKey]);

  const grid = document.getElementById("grid");
  const status = document.getElementById("lobbyStatus");

  // âœ… IMPORTANT FIX
  if (data.currentPlayer === playerNum) {
    grid.style.pointerEvents = "auto";
    status.innerText = "Your turn";
  } else {
    grid.style.pointerEvents = "none";
    status.innerText = "Opponent's turn";
  }

  listenGame();
}

/********************
 ðŸ§© BOARD GENERATION
********************/
function generateBoard(){
  return [...Array(25).keys()].map(i => i + 1).sort(() => Math.random() - 0.5);
}

function renderBoard(numbers){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  cells = [];
  completed.clear();
  bingo = false;

  numbers.forEach(num => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = num;
    cell.onclick = () => handleCellClick(num);
    cells.push(cell);
    grid.appendChild(cell);
  });
}

/********************
 ðŸ–±ï¸ CELL CLICK
********************/
function handleCellClick(number){
  roomRef.once("value", snap => {
    const data = snap.val();
    if(!data || data.currentPlayer !== playerNum) return;
    if(data.calledNumbers.includes(number)) return;

    roomRef.update({
      calledNumbers: [...data.calledNumbers, number],
      currentPlayer: playerNum === 1 ? 2 : 1
    });
  });
}

/********************
 ðŸ‘‚ GAME LISTENER
********************/
function listenGame(){
  roomRef.on("value", snap => {
    const data = snap.val();
    if(!data) return;

    updateBoard(data.calledNumbers);

    const grid = document.getElementById("grid");
    const status = document.getElementById("lobbyStatus");

    if(data.currentPlayer === playerNum){
      grid.style.pointerEvents = "auto";
      status.innerText = "Your turn";
    } else {
      grid.style.pointerEvents = "none";
      status.innerText = "Opponent's turn";
    }
  });
}

/********************
 ðŸ† BINGO LOGIC (UNCHANGED)
********************/
function updateBoard(called){
  completed.clear();

  cells.forEach(cell => {
    cell.classList.remove("marked","completed");
    if(called.includes(Number(cell.textContent))){
      cell.classList.add("marked");
    }
  });

  const lines = [];
  for(let r=0;r<5;r++) lines.push([...Array(5)].map((_,c)=>r*5+c));
  for(let c=0;c<5;c++) lines.push([...Array(5)].map((_,r)=>r*5+c));

  lines.forEach((line,i)=>{
    if(line.every(idx => cells[idx].classList.contains("marked"))){
      line.forEach(idx => cells[idx].classList.add("completed"));
      completed.add(i);
    }
  });

  ["b","i","n","g","o"].forEach((id,i)=>{
    document.getElementById(id)
      .classList.toggle("active", completed.size > i);
  });

  if(completed.size >= 5 && !bingo){
    bingo = true;
    document.getElementById("bingoMessage").style.display = "block";
  }
}
</script>
</body>
</html>

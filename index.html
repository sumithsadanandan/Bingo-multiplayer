<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sumith's Bingo</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f6f4ff; color:#222; transition:background 0.3s;}
body.pastel{background:#f6f4ff;}
body.neon{background:#1a1a2e; color:#eee;}
body.soft{background:#e8f4f8; color:#333;}
header{padding:16px;text-align:center;font-weight:700;font-size:24px;}
.wrap{max-width:480px;margin:20px auto;padding:12px;}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,0.1);}
body.neon .card{background:#16213e;color:#eee;}
body.soft .card{background:#fff;}
button,input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:15px;margin-top:10px;cursor:pointer;}
button{background:#6c5ce7;color:#fff;font-weight:600;border:none;}
button:hover{background:#5f4fd1;}
button:disabled{background:#ccc;cursor:not-allowed;}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:16px}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:12px;background:#eae9ff;font-weight:700;font-size:18px;cursor:pointer;user-select:none;transition:all 0.2s;}
body.neon .cell{background:#0f3460;}
body.soft .cell{background:#d4e9f2;}
.cell:hover{transform:scale(1.05);}
.cell.marked{background:#b8f2c2;color:#000;}
body.neon .cell.marked{background:#48c774;color:#000;}
body.soft .cell.marked{background:#a8dadc;color:#000;}
.cell.not-my-turn{cursor:not-allowed;opacity:0.6;}
.status{text-align:center;margin-top:12px;font-weight:600;font-size:16px;}
.hidden{display:none!important;}
#roomCodeDisplay{background:#e3f2fd;padding:12px;border-radius:8px;margin-bottom:12px;font-size:18px;font-weight:700;}
.info-box{background:#e8f5e9;padding:12px;border-radius:8px;margin-top:12px;font-size:14px;}
body.neon .info-box{background:#2d4a3e;}
#bingoLabel{font-size:28px;font-weight:800;color:#6c5ce7;margin-top:16px;}
body.neon #bingoLabel{color:#48c774;}
.winner-msg{color:#e74c3c;font-size:20px;font-weight:800;}
.loading{text-align:center;padding:20px;color:#999;}
</style>
</head>
<body class="pastel">
<header>üéâ Sumith's Bingo</header>
<div class="wrap">
  <div id="loading" class="loading">Loading Firebase...</div>
  
  <div id="lobby" class="card hidden">
    <div id="roomCodeDisplay" class="status hidden"></div>
    <button id="createBtn">Create Room</button>
    <input id="roomInput" placeholder="Enter room code to join">
    <button id="joinBtn">Join Room</button>
    <select id="themeSelect">
      <option value="pastel">üå∏ Pastel</option>
      <option value="neon">‚ö° Neon</option>
      <option value="soft">üßä Soft</option>
    </select>
    <p id="lobbyStatus" class="status"></p>
    <button id="startBtn" class="hidden" disabled>Waiting for players...</button>
  </div>

  <div id="game" class="card hidden">
    <div id="roomLabel" class="status"></div>
    <div id="scoreBoard" class="status" style="background:#fff3cd;padding:10px;border-radius:8px;margin:10px 0;font-size:18px;">
      <strong>Score:</strong> P1: <span id="p1Score">0</span> | P2: <span id="p2Score">0</span>
    </div>
    <div id="turnLabel" class="status"></div>
    <div class="info-box" id="infoBox">Waiting for game to start...</div>
    <div id="board" class="grid"></div>
    <div id="bingoLabel" class="status"></div>
    <button id="newGameBtn" class="hidden">New Game</button>
  </div>
</div>

<!-- Firebase v9 Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Wait for Firebase to load
window.addEventListener('load', function() {
  // Check if Firebase loaded
  if (typeof firebase === 'undefined') {
    document.getElementById('loading').innerHTML = '‚ùå Firebase failed to load. Please check your internet connection and refresh.';
    return;
  }
  
  initApp();
});

function initApp() {
  /* ====== Firebase Config ====== */
  try {
    firebase.initializeApp({
      apiKey: "AIzaSyCKZ-ktAV8MPyZbjwkuzszTUEzHXvoKOGA",
      authDomain: "bingo-multiplayer-315fb.firebaseapp.com",
      databaseURL: "https://bingo-multiplayer-315fb-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bingo-multiplayer-315fb",
      storageBucket: "bingo-multiplayer-315fb.firebasestorage.app",
      messagingSenderId: "157740745674",
      appId: "1:157740745674:web:a4bdabb3bc8a05d024c533",
      measurementId: "G-88SZ629W0B"
    });
  } catch (error) {
    document.getElementById('loading').innerHTML = '‚ùå Firebase initialization error: ' + error.message;
    return;
  }
  
  const db = firebase.database();
  
  // Hide loading, show lobby
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('lobby').classList.remove('hidden');

  /* ===== Variables ===== */
  let roomId = null;
  let playerId = null;
  let isOwner = false;
  let myBoard = [];
  let myMarked = [];
  let completedLines = new Set();
  let gameStarted = false;
  let currentTurn = null;
  let listenersAttached = false;

  /* UI refs */
  const createBtn = document.getElementById('createBtn');
  const joinBtn = document.getElementById('joinBtn');
  const startBtn = document.getElementById('startBtn');
  const newGameBtn = document.getElementById('newGameBtn');
  const roomInput = document.getElementById('roomInput');
  const lobbyStatus = document.getElementById('lobbyStatus');
  const lobbyCard = document.getElementById('lobby');
  const gameCard = document.getElementById('game');
  const roomLabel = document.getElementById('roomLabel');
  const roomCodeDisplay = document.getElementById('roomCodeDisplay');
  const turnLabel = document.getElementById('turnLabel');
  const boardEl = document.getElementById('board');
  const bingoLabel = document.getElementById('bingoLabel');
  const themeSelect = document.getElementById('themeSelect');
  const infoBox = document.getElementById('infoBox');
  const p1Score = document.getElementById('p1Score');
  const p2Score = document.getElementById('p2Score');

  /* ===== Theme change ===== */
  themeSelect.onchange = e => document.body.className = e.target.value;

  /* ===== Helper ===== */
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  /* ===== Create Room ===== */
  createBtn.onclick = async () => {
    try {
      roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
      playerId = "P1";
      isOwner = true;
      
      await db.ref(`rooms/${roomId}`).set({
        players: { P1: true },
        started: false,
        turn: "P1",
        boards: {},
        marks: {},
        scores: { P1: 0, P2: 0 }
      });
      
      enterRoomUI();
    } catch (error) {
      alert('Error creating room: ' + error.message);
    }
  };

  /* ===== Join Room ===== */
  joinBtn.onclick = async () => {
    try {
      const val = (roomInput.value || "").trim().toUpperCase();
      if (!val) {
        alert("Enter room code");
        return;
      }
      
      // Check if room exists
      const roomSnap = await db.ref(`rooms/${val}`).once('value');
      if (!roomSnap.exists()) {
        alert("Room not found!");
        return;
      }
      
      const roomData = roomSnap.val();
      const players = Object.keys(roomData.players || {});
      
      if (players.length >= 2) {
        alert("Room is full!");
        return;
      }
      
      roomId = val;
      playerId = "P2";
      isOwner = false;
      
      await db.ref(`rooms/${roomId}/players/P2`).set(true);
      enterRoomUI();
    } catch (error) {
      alert('Error joining room: ' + error.message);
    }
  };

  /* ===== Enter game UI ===== */
  function enterRoomUI() {
    // Hide create/join buttons, show room info
    createBtn.style.display = 'none';
    joinBtn.style.display = 'none';
    roomInput.style.display = 'none';
    themeSelect.style.display = 'none';
    
    // Show room code
    roomCodeDisplay.classList.remove('hidden');
    roomCodeDisplay.innerHTML = `<strong>üéÆ Room Code: ${roomId}</strong><br><small>Share this code with Player 2</small>`;
    
    roomLabel.innerText = `Room: ${roomId} | You are Player ${playerId.substring(1)}`;
    
    // Show start button for owner
    if (isOwner) {
      startBtn.classList.remove('hidden');
    }
    
    if (!listenersAttached) {
      attachRoomListener();
      listenersAttached = true;
    }
  }

  /* ===== Start game ===== */
  startBtn.onclick = async () => {
    try {
      const snap = await db.ref(`rooms/${roomId}/players`).once('value');
      const playersObj = snap.val() || {};
      
      if (Object.keys(playersObj).length < 2) {
        alert("Need 2 players to start!");
        return;
      }
      
      // Generate boards for both players
      const p1Board = shuffle([...Array(25).keys()].map(n => n + 1));
      const p2Board = shuffle([...Array(25).keys()].map(n => n + 1));
      
      const updates = {};
      updates[`rooms/${roomId}/boards/P1`] = p1Board;
      updates[`rooms/${roomId}/boards/P2`] = p2Board;
      updates[`rooms/${roomId}/marks/P1`] = {};
      updates[`rooms/${roomId}/marks/P2`] = {};
      updates[`rooms/${roomId}/started`] = true;
      updates[`rooms/${roomId}/turn`] = "P1";
      updates[`rooms/${roomId}/winner`] = null;
      
      await db.ref().update(updates);
    } catch (error) {
      alert('Error starting game: ' + error.message);
    }
  };

  /* ===== New Game ===== */
  newGameBtn.onclick = async () => {
    try {
      // Generate new boards
      const p1Board = shuffle([...Array(25).keys()].map(n => n + 1));
      const p2Board = shuffle([...Array(25).keys()].map(n => n + 1));
      
      const updates = {};
      updates[`rooms/${roomId}/boards/P1`] = p1Board;
      updates[`rooms/${roomId}/boards/P2`] = p2Board;
      updates[`rooms/${roomId}/marks/P1`] = {};
      updates[`rooms/${roomId}/marks/P2`] = {};
      updates[`rooms/${roomId}/turn`] = "P1";
      updates[`rooms/${roomId}/winner`] = null;
      updates[`rooms/${roomId}/started`] = true;
      
      await db.ref().update(updates);
      
      // Reset local state AFTER Firebase update
      myBoard = [];
      myMarked = [];
      completedLines.clear();
      gameStarted = false;
      
      // Hide new game button
      newGameBtn.classList.add('hidden');
    } catch (error) {
      alert('Error starting new game: ' + error.message);
    }
  };

  /* ===== Room listener ===== */
  function attachRoomListener() {
    const roomRef = db.ref(`rooms/${roomId}`);
    
    roomRef.on('value', snap => {
      const data = snap.val();
      if (!data) return;
      
      const players = Object.keys(data.players || {});
      lobbyStatus.innerText = `Players: ${players.length}/2`;
      
      // Update scores
      if (data.scores) {
        p1Score.innerText = data.scores.P1 || 0;
        p2Score.innerText = data.scores.P2 || 0;
      }
      
      // Update start button - only show for owner when 2 players are in
      if (isOwner) {
        startBtn.classList.remove('hidden');
        if (players.length === 2 && !data.started) {
          startBtn.disabled = false;
          startBtn.innerText = "Start Game";
        } else if (data.started) {
          startBtn.disabled = true;
          startBtn.innerText = "Game Started";
        } else {
          startBtn.disabled = true;
          startBtn.innerText = "Waiting for Player 2...";
        }
      } else {
        // Non-owner - show waiting message
        if (!data.started) {
          lobbyStatus.innerText = `Players: ${players.length}/2 - Waiting for owner to start...`;
        }
      }
      
      // Update turn
      currentTurn = data.turn;
      const isMyTurn = currentTurn === playerId;
      
      // Check for winner
      if (data.winner) {
        const winnerText = data.winner === playerId ? "üéâ YOU WIN! üéâ" : `${data.winner} Won!`;
        bingoLabel.innerHTML = `<div class="winner-msg">${winnerText}</div>`;
        infoBox.innerText = "Game Over! " + (data.winner === playerId ? "You get a point!" : data.winner + " gets a point!");
        
        // Show New Game button (anyone can start a new game)
        newGameBtn.classList.remove('hidden');
        newGameBtn.innerText = "üîÑ Play Again";
        return;
      } else {
        // Hide new game button if no winner
        newGameBtn.classList.add('hidden');
      }
      
      // Game started - load board and switch to game view
      if (data.started && data.boards && data.boards[playerId]) {
        // Switch to game view
        lobbyCard.classList.add('hidden');
        gameCard.classList.remove('hidden');
        
        gameStarted = true;
        
        turnLabel.innerText = isMyTurn ? "üü¢ Your Turn!" : `‚è≥ Waiting for ${currentTurn}`;
        turnLabel.style.color = isMyTurn ? "#27ae60" : "#e67e22";
        
        // ALWAYS reload board from Firebase (important for new games)
        myBoard = data.boards[playerId];
        myMarked = Array(25).fill(false);
        completedLines.clear();
        
        // Update marks
        const marksObj = data.marks?.[playerId] || {};
        Object.keys(marksObj).forEach(idx => {
          myMarked[Number(idx)] = true;
        });
        
        infoBox.innerText = isMyTurn ? "Click a number to mark it" : "Wait for your turn";
        renderBoard();
        updateBingoLabel();
      }
    });
  }

  /* ===== Render board ===== */
  function renderBoard() {
    if (myBoard.length === 0) return;
    
    boardEl.innerHTML = '';
    const isMyTurn = currentTurn === playerId;
    
    for (let i = 0; i < 25; i++) {
      const n = myBoard[i];
      const cell = document.createElement('div');
      cell.className = 'cell';
      
      if (myMarked[i]) {
        cell.classList.add('marked');
      }
      
      if (!isMyTurn) {
        cell.classList.add('not-my-turn');
      }
      
      cell.innerText = n;
      cell.onclick = () => onCellClick(i, n);
      boardEl.appendChild(cell);
    }
  }

  /* ===== Cell click ===== */
  async function onCellClick(idx, number) {
    try {
      if (!gameStarted) return;
      if (currentTurn !== playerId) {
        infoBox.innerText = "‚ö†Ô∏è Not your turn!";
        return;
      }
      if (myMarked[idx]) return;
      
      // Mark this number on ALL boards that have it
      const boardsSnap = await db.ref(`rooms/${roomId}/boards`).once('value');
      const boardsObj = boardsSnap.val() || {};
      
      const updates = {};
      
      Object.keys(boardsObj).forEach(pid => {
        const board = boardsObj[pid];
        const index = board.indexOf(number);
        if (index >= 0) {
          updates[`rooms/${roomId}/marks/${pid}/${index}`] = true;
        }
      });
      
      // Switch turn
      updates[`rooms/${roomId}/turn`] = playerId === "P1" ? "P2" : "P1";
      
      await db.ref().update(updates);
    } catch (error) {
      console.error('Error marking cell:', error);
      infoBox.innerText = "‚ùå Error marking cell. Try again.";
    }
  }

  /* ===== Bingo logic ===== */
  function updateBingoLabel() {
    const letters = "BINGO";
    completedLines.clear();
    
    // Check rows
    for (let r = 0; r < 5; r++) {
      const idxs = [0, 1, 2, 3, 4].map(c => r * 5 + c);
      if (idxs.every(i => myMarked[i])) {
        completedLines.add('R' + r);
      }
    }
    
    // Check columns
    for (let c = 0; c < 5; c++) {
      const idxs = [0, 1, 2, 3, 4].map(r => r * 5 + c);
      if (idxs.every(i => myMarked[i])) {
        completedLines.add('C' + c);
      }
    }
    
    const count = completedLines.size;
    
    if (count >= 5) {
      bingoLabel.innerText = "üéâ BINGO! üéâ";
      declareWinner();
    } else {
      bingoLabel.innerText = letters.slice(0, count);
    }
  }

  /* ===== Declare winner ===== */
  async function declareWinner() {
    try {
      // Check if already has winner
      const winnerSnap = await db.ref(`rooms/${roomId}/winner`).once('value');
      if (!winnerSnap.val()) {
        // Set winner
        await db.ref(`rooms/${roomId}/winner`).set(playerId);
        
        // Increment score
        const scoresSnap = await db.ref(`rooms/${roomId}/scores`).once('value');
        const currentScores = scoresSnap.val() || { P1: 0, P2: 0 };
        currentScores[playerId] = (currentScores[playerId] || 0) + 1;
        await db.ref(`rooms/${roomId}/scores`).set(currentScores);
      }
    } catch (error) {
      console.error('Error declaring winner:', error);
    }
  }
}
</script>
</body>
</html>

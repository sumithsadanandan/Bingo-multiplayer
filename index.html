<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Online Bingo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:Poppins,sans-serif;
  background:#fde2e4;
  display:flex;
  justify-content:center;
}
.app{max-width:420px;width:100%;padding:16px;}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.cell{
  aspect-ratio:1;
  border-radius:14px;
  background:#fff;
  border:2px solid #ddd;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:600;
  cursor:pointer;
}
.cell.marked{background:#e6dbff;}
.cell.completed{background:#c8f7dc;}
.bingo{display:flex;gap:10px;justify-content:center;margin:10px 0;}
.letter{
  width:40px;height:40px;border-radius:50%;
  border:2px solid #ec407a;
  display:flex;align-items:center;justify-content:center;
}
.letter.active{background:#ec407a;color:#fff;}
#bingoMessage{font-size:24px;text-align:center;margin-top:10px;display:none;}
</style>
</head>

<body>
<div class="app">

<h2>Online Bingo</h2>

<div>
  <input id="roomInput" placeholder="Room code"/>
  <button onclick="joinRoom()">Join</button>
</div>

<p id="status"></p>

<div class="bingo">
  <div class="letter" id="b">B</div>
  <div class="letter" id="i">I</div>
  <div class="letter" id="n">N</div>
  <div class="letter" id="g">G</div>
  <div class="letter" id="o">O</div>
</div>

<div class="grid" id="grid"></div>

<div id="bingoMessage">ðŸŽ‰ BINGO ðŸŽ‰</div>

</div>

<script>
/* ðŸ”¹ Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCKZ-ktAV8MPyZbjwkuzszTUEzHXvoKOGA",
  authDomain: "bingo-multiplayer-315fb.firebaseapp.com",
  databaseURL: "https://bingo-multiplayer-315fb-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bingo-multiplayer-315fb",
  storageBucket: "bingo-multiplayer-315fb.firebasestorage.app",
  messagingSenderId: "157740745674",
  appId: "1:157740745674:web:a4bdabb3bc8a05d024c533",
  measurementId: "G-88SZ629W0B"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ðŸ”¹ Game state */
const SIZE = 5;
let cells = [];
let completed = new Set();
let bingo = false;

let roomCode = null;
let playerNum = null;
let roomRef = null;
let roomListener = null;
let boardInitialized = false;

/* ðŸ”¹ Join room */
function joinRoom(){
  roomCode = document.getElementById('roomInput').value.trim();
  if(!roomCode) return;

  cleanupListeners();

  roomRef = db.ref('rooms/' + roomCode);

  roomRef.transaction(room=>{
    if(!room){
      room = {
        players: 1,
        boards: { p1: generateNumbers() },
        calledNumbers: [],
        currentPlayer: 1
      };
      playerNum = 1;
    } else if(room.players === 1){
      room.players = 2;
      room.boards.p2 = generateNumbers();
      playerNum = 2;
    }
    return room;
  }).then(()=>{
    listenRoom();
  });
}

/* ðŸ”¹ Generate board numbers ONCE */
function generateNumbers(){
  return [...Array(25).keys()].map(i=>i+1).sort(()=>Math.random()-0.5);
}

/* ðŸ”¹ Populate grid ONCE */
function populateGrid(numbers){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  cells = [];

  numbers.forEach(n=>{
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.textContent = n;
    cell.onclick = ()=>markNumber(n);
    cells.push(cell);
    grid.appendChild(cell);
  });

  boardInitialized = true;
}

/* ðŸ”¹ Mark number */
function markNumber(number){
  if(bingo) return;

  roomRef.once('value').then(s=>{
    const d = s.val();
    if(d.currentPlayer !== playerNum) return;

    const called = d.calledNumbers || [];
    if(!called.includes(number)){
      roomRef.update({
        calledNumbers: [...called, number],
        currentPlayer: playerNum === 1 ? 2 : 1
      });
    }
  });
}

/* ðŸ”¹ Listen room (ONE listener only) */
function listenRoom(){
  roomListener = roomRef.on('value', snap=>{
    const d = snap.val();
    if(!d) return;

    document.getElementById('status').innerText =
      d.currentPlayer === playerNum ? "Your turn" : "Opponent's turn";

    const boardKey = playerNum === 1 ? 'p1' : 'p2';

    if(!boardInitialized){
      populateGrid(d.boards[boardKey]);
    }

    updateMarks(d.calledNumbers || []);
  });
}

/* ðŸ”¹ Bingo logic (rows + columns only) */
function updateMarks(called){
  completed.clear();
  bingo = false;

  cells.forEach(c=>{
    c.classList.remove('marked','completed');
  });

  cells.forEach(c=>{
    if(called.includes(Number(c.textContent))){
      c.classList.add('marked');
    }
  });

  const lines=[];
  for(let r=0;r<SIZE;r++) lines.push([...Array(SIZE)].map((_,c)=>r*SIZE+c));
  for(let c=0;c<SIZE;c++) lines.push([...Array(SIZE)].map((_,r)=>r*SIZE+c));

  lines.forEach((line,i)=>{
    if(line.every(idx=>called.includes(Number(cells[idx].textContent)))){
      line.forEach(idx=>cells[idx].classList.add('completed'));
      completed.add(i);
    }
  });

  ['b','i','n','g','o'].forEach((id,i)=>{
    document.getElementById(id).classList.toggle('active', completed.size > i);
  });

  if(completed.size >= 5){
    bingo = true;
    document.getElementById('bingoMessage').style.display = 'block';
  }
}

/* ðŸ”¹ Cleanup listeners */
function cleanupListeners(){
  if(roomRef && roomListener){
    roomRef.off('value', roomListener);
  }
  roomListener = null;
  boardInitialized = false;
  completed.clear();
  document.getElementById('grid').innerHTML = '';
  document.getElementById('bingoMessage').style.display = 'none';
}
</script>
</body>
</html>
